FROM i386/debian:stretch

RUN echo 'deb-src http://deb.debian.org/debian stretch main' >> /etc/apt/sources.list
RUN echo 'deb-src http://security.debian.org/debian-security stretch/updates main' >> /etc/apt/sources.list
RUN echo 'deb-src http://deb.debian.org/debian stretch-updates main' >> /etc/apt/sources.list

RUN apt-get update
RUN apt-get -y build-dep wine
RUN apt-get -y install git llvm clang wget

RUN git clone https://github.com/tpoechtrager/osxcross /root/osxcross

COPY darwin/SDK/MacOSX10.11.sdk.tar.xz /root/osxcross/tarballs/

RUN cd /root/osxcross && UNATTENDED=1 ./build.sh

ENV PATH="/root/osxcross/target/bin:${PATH}"
ENV MACOSX_DEPLOYMENT_TARGET="10.11"

RUN mkdir -p /root/osxcross/target/macports
RUN printf "packages.macports.org" > /root/osxcross/target/macports/MIRROR

RUN osxcross-macports -32 fakeinstall -v pulseaudio
RUN osxcross-macports -32 install -v wine-devel
RUN osxcross-macports -32 install gnutls-dev
# RUN env MACOSX_DEPLOYMENT_TARGET=10.12 osxcross-macports install MoltenVK


### Vulkan
WORKDIR /root/
RUN wget https://sdk.lunarg.com/sdk/download/1.1.92.1/mac/vulkansdk-macos-1.1.92.1.tar.gz
RUN tar -xvf vulkansdk-macos-1.1.92.1.tar.gz

WORKDIR /root/vulkansdk-macos-1.1.92.1/MoltenVK/include
RUN mv MoltenVK /root/osxcross/target/macports/pkgs/opt/local/include/

WORKDIR /root/vulkansdk-macos-1.1.92.1/MoltenVK/macOS
RUN mv framework/* /root/osxcross/target/macports/pkgs/opt/local/Library/Frameworks/
RUN mv static/* /root/osxcross/target/macports/pkgs/opt/local/lib/
RUN mv dynamic/* /root/osxcross/target/macports/pkgs/opt/local/lib/

# WORKDIR /root/vulkansdk-macos-1.1.92.1/macOS
# RUN mv Frameworks/vulkan.framework/ /root/osxcross/target/macports/pkgs/opt/local/Library/Frameworks/
# RUN mv bin/* /root/osxcross/target/macports/pkgs/opt/local/bin/
# RUN mv etc/* /root/osxcross/target/macports/pkgs/opt/local/etc/
# RUN mv lib/pkgconfig/* /root/osxcross/target/macports/pkgs/opt/local/lib/pkgconfig/
# RUN rmdir lib/pkgconfig/
# RUN mv lib/* /root/osxcross/target/macports/pkgs/opt/local/lib/
# RUN mv include/* /root/osxcross/target/macports/pkgs/opt/local/include/

### VK3D3
WORKDIR /root
RUN git clone https://github.com/KhronosGroup/SPIRV-Headers
RUN apt-get install -y libtool-bin
COPY darwin/install_vkd3d.sh /root/

## Import fix
COPY darwin/fix_imports.sh /root/

## MS Hook Prologue support
COPY ms_hook_prologue/*.patch /root/
COPY ms_hook_prologue/install_clang_ms_hook_prologue_support.sh /root/
RUN bash /root/install_clang_ms_hook_prologue_support.sh

## Removing preinstalled wine libs to prevent conflict
RUN rm /root/osxcross/target/macports/pkgs/opt/local/lib/libwine.*
RUN rm -r /root/osxcross/target/macports/pkgs/opt/local/lib/wine